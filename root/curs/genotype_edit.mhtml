<%args>
$schema
$title
$pub
$multi_organism_mode
$curs_root_uri
$annotation_count => 0
$genotype_id => ''
$edit_or_duplicate
</%args>

<div class="curs-genotype-edit">
<div ng-controller="MultiAlleleCtrl" id="curs-multi-allele-select"
     ng-init="init('<% $edit_or_duplicate %>', '<% $genotype_id %>')";
     class="curs-box ng-cloak">
    <div class="curs-box-title">
      <span ng-if="isEditing">
Add, edit, or delete alleles of genes from the list until the genotype is
correctly described.
      </span>
      <span ng-if="!isEditing">
Specify alleles of genes from the list, until the new genotype is complete.
      </span>
    </div>
    <div class="curs-box-body">

      <div class="row">
        <div class="col-sm-6 col-md-6">
          <div>
      Name: <input type="text" title="Click to edit (optional) genotype name" href="#"
             placeholder="short genotype name (optional) ..."
             size="50"
             ng-model="data.genotype_name" />
            <help-icon key="genotype_edit_name_input"></help-icon>
          </div>
          <div>
      Background: <input type="text" title="Click to edit (options) genotype background" href="#"
             placeholder="genotype background (optional) ..."
             size="50"
             ng-model="data.genotype_background" />
            <help-icon key="genotype_edit_background_input"></help-icon>
          </div>
        </div>
        <div class="col-sm-6 col-md-6">
% if ($annotation_count > 0) {
      <div class="curs-right-info-message">
%   if ($annotation_count == 1) {
        Note: this genotype has an existing annotation
%   } else {
        Note: this genotype has <% $annotation_count %> existing annotations
%   }
      </div>
% }
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6 col-md-6">
          <div ng-hide="genes.length">
            <img src="<% $c->uri_for('/static/images/spinner.gif') %>"/>
            Loading genes ...
          </div>
          <div class="curs-genotype-edit-gene-list" ng-show="genes.length">
            <table class="list">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Identifier</th>
                  <th>&nbsp;</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="gene in genes">
                  <td>{{gene.primary_name}}</td>
                  <td>{{gene.primary_identifier}}</td>
                  <td>
                    <button class="btn btn-primary btn-xs"
                            ng-click="openAlleleEditDialog({gene: gene})">Add allele ..</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="col-sm-6 col-md-6">
          <div ng-show="alleles.length == 0">
[No alleles added yet]
          </div>

          <div id="multi-allele-genotype" class="ng-cloak" ng-show="alleles.length">

            <div>
The alleles of this genotype:
            </div>

            <table class="list">
              <thead>
                <tr>
                  <th>Gene</th>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Expression</th>
                </tr>
              </thead>
              <tbody ng-repeat="allele in alleles">
                <td>{{allele.gene_display_name}}</td>
                <td>{{allele.name}}</td>
                <td>{{allele.type}}</td>
                <td>{{allele.description}}</td>
                <td>{{allele.expression}}</td>
                <td class="curs-table-row-remove">
                  <div>
                    <a href="#" style="white-space: nowrap;" ng-click="openAlleleEditDialog(allele)">Edit</a>
                  </div>
                  <div>
                    <a href="#" style="white-space: nowrap;" ng-click="removeAllele(allele)">Delete</a>
                  </div>
                </td>
            </tbody>
            </table>
          </div>
        </div>
      </div>
      <button type="submit" class="btn btn-primary curs-finish-button"
              title="{{ isValid() ? 'Add genotype' : 'At least one allele for each gene is required' }}"
              ng-click="store()" ng-disabled="!isValid()">Finish</button>
      <button type="submit" class="btn btn-warning curs-finish-button"
              ng-click="cancel()">Cancel</button>
      <div class="upload-genes-link">
        <a ng-click="openSingleGeneAddDialog()">Add another gene from the paper ...</a>
      </div>
      <div class="clearall"></div>
      <label class="curs-finish-checkbox"
             title="If selected you can immediately add another genotype. Otherwise, go to genotype details page">
        <input type="checkbox" ng-model="data.addAnother">Add another genotype
      </label>
  </div>
</div>

<%init>
use Canto::Curs;
use Canto::Track;
use Canto::Curs::GeneProxy;

my $root_path = $c->stash()->{curs_root_path};
my $upload_path = $c->uri_for("$root_path/gene_upload",
                              { return_path => $c->req()->uri() });
</%init>
